<!DOCTYPE html>
<html lang="en" dir="auto" data-theme="dark">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>The lessons I learned from setting up an API server via perl script | Xi&#39;s Blog</title>
<meta name="keywords" content="Perl, API, IPC, debugging">
<meta name="description" content="Problem Statement
Recently When I was trying to set up an API server in a perl script to do some unit tests, I met lots of trouble.
In conclusion, the trouble can be classfied as 3 parts:

The residual server processes can&rsquo;t be killed properly.
Program stucked after launch the API server.
stdin, stdout, stderr on windows.

Error examples
The residual server processes can&rsquo;t be killed.


1


system(perl server.pl daemon -l http://*:0);


Use the command above in main test script will launch an API server in a child process. The residual server processes should be killed without any left after the tests. At first I use &ldquo;system&rdquo; to run the command, and then kill it in a different system command via:">
<meta name="author" content="Xi Chen">
<link rel="canonical" href="https://xichen1997.github.io/posts/2023-11-21-the-lessons-i-learned-from-setting-up-an-api-server-via-perl-script/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.56bf4be95d09faf55cd507c845718ccfcabb2e24e37f8fa5a66f9fa098252b06.css" integrity="sha256-Vr9L6V0J&#43;vVc1QfIRXGMz8q7LiTjf4&#43;lpm&#43;foJglKwY=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://xichen1997.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://xichen1997.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://xichen1997.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://xichen1997.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://xichen1997.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://xichen1997.github.io/posts/2023-11-21-the-lessons-i-learned-from-setting-up-an-api-server-via-perl-script/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript>
<script>
    if (localStorage.getItem("pref-theme") === "light") {
        document.querySelector("html").dataset.theme = 'light';
    }

</script>
<script>
MathJax = {
  tex: {
    inlineMath: [['$', '$'], ['\\(', '\\)']],
    displayMath: [['$$', '$$'], ['\\[', '\\]']],
    processEscapes: true,
    processEnvironments: true
  },
  options: {
    skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
  }
};

window.addEventListener('load', (event) => {
    document.querySelectorAll("mjx-container").forEach(function(x){
      x.parentElement.classList += 'has-jax'})
  });
</script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<meta property="og:url" content="https://xichen1997.github.io/posts/2023-11-21-the-lessons-i-learned-from-setting-up-an-api-server-via-perl-script/">
  <meta property="og:site_name" content="Xi&#39;s Blog">
  <meta property="og:title" content="The lessons I learned from setting up an API server via perl script">
  <meta property="og:description" content="Problem Statement Recently When I was trying to set up an API server in a perl script to do some unit tests, I met lots of trouble.
In conclusion, the trouble can be classfied as 3 parts:
The residual server processes can’t be killed properly. Program stucked after launch the API server. stdin, stdout, stderr on windows. Error examples The residual server processes can’t be killed. 1 system(perl server.pl daemon -l http://*:0); Use the command above in main test script will launch an API server in a child process. The residual server processes should be killed without any left after the tests. At first I use “system” to run the command, and then kill it in a different system command via:">
  <meta property="og:locale" content="en-us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-11-21T21:05:14-04:00">
    <meta property="article:modified_time" content="2023-11-21T21:05:14-04:00">
    <meta property="article:tag" content="Perl">
    <meta property="article:tag" content="API">
    <meta property="article:tag" content="IPC">
    <meta property="article:tag" content="Debugging">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="The lessons I learned from setting up an API server via perl script">
<meta name="twitter:description" content="Problem Statement
Recently When I was trying to set up an API server in a perl script to do some unit tests, I met lots of trouble.
In conclusion, the trouble can be classfied as 3 parts:

The residual server processes can&rsquo;t be killed properly.
Program stucked after launch the API server.
stdin, stdout, stderr on windows.

Error examples
The residual server processes can&rsquo;t be killed.


1


system(perl server.pl daemon -l http://*:0);


Use the command above in main test script will launch an API server in a child process. The residual server processes should be killed without any left after the tests. At first I use &ldquo;system&rdquo; to run the command, and then kill it in a different system command via:">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://xichen1997.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "The lessons I learned from setting up an API server via perl script",
      "item": "https://xichen1997.github.io/posts/2023-11-21-the-lessons-i-learned-from-setting-up-an-api-server-via-perl-script/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "The lessons I learned from setting up an API server via perl script",
  "name": "The lessons I learned from setting up an API server via perl script",
  "description": "Problem Statement Recently When I was trying to set up an API server in a perl script to do some unit tests, I met lots of trouble.\nIn conclusion, the trouble can be classfied as 3 parts:\nThe residual server processes can\u0026rsquo;t be killed properly. Program stucked after launch the API server. stdin, stdout, stderr on windows. Error examples The residual server processes can\u0026rsquo;t be killed. 1 system(perl server.pl daemon -l http://*:0); Use the command above in main test script will launch an API server in a child process. The residual server processes should be killed without any left after the tests. At first I use \u0026ldquo;system\u0026rdquo; to run the command, and then kill it in a different system command via:\n",
  "keywords": [
    "Perl", "API", "IPC", "debugging"
  ],
  "articleBody": "Problem Statement Recently When I was trying to set up an API server in a perl script to do some unit tests, I met lots of trouble.\nIn conclusion, the trouble can be classfied as 3 parts:\nThe residual server processes can’t be killed properly. Program stucked after launch the API server. stdin, stdout, stderr on windows. Error examples The residual server processes can’t be killed. 1 system(perl server.pl daemon -l http://*:0); Use the command above in main test script will launch an API server in a child process. The residual server processes should be killed without any left after the tests. At first I use “system” to run the command, and then kill it in a different system command via:\n1 ps aux \\| grep \"xxx\" \\| awk {print $2}\" \\| xargs kill However, my tests need to be run on all platform including windows, then it’s not possible to use the UNIX/MAC specific command to kill the processes.\nOf course I can use\n1 print \"$^0\" to detect different OS and use different command to kill them, but I don’t because I am afraid of some problem which unspecified platform will show up. I would like to use the naive perl method.\nThen the question become how to get the pid from the “system” command in perl, here, I use open3 [https://perldoc.perl.org/IPC::Open3]\nThe open3 will return a pid number, which could be used by perl to execute:\nKill ‘TERM’, $pid. which is quiet convenient.\nThe command is:\n1 2 my $pid = open3(my $in, my $out, my $err, \"perl server.pl daemon -l http://*:0\"); kill 'TERM', $pid; It should be fine to solve the problem, however, then I met the second question: The test is stucked once the child processes launch the API server.\nProgram stucked after launch the API server. This is quiet interesting caused by open3.\nopen3 will open the subprocess with its stdin, stdout and stderr. However, there is buffer setting in linux terminal(not sure if there is in windows os.). So the buffer always waiting for some output to accumulate and then release them. The api server always waiting for new output, however, it never reached the requirements of the buffer. Then the program stucked.\nTwo ways to solve the problem:\nuse “unbuffer” to launch the server:\n1 my $pid = open3(my $in, my $out, my $err, \"unbuffer perl server.pl daemon -l http://*:0\"); However, this can’t be done on windows.\nIn the server.pl, add |=1 to force flush buffer.\nIt should solve the problem of stucked program.\nHowever, new problem showed up:\nThe server.pl still alive after successfully tests.\nI can still use ps aux | grep \"server.pl\" to find 4-5 processes.\nAfter careful thinking, I made an experiment which I will comment the “kill” in each tests, and after running the tests I found the residual processes have twice than before. This means the open3 launch not only 1 subprocess but 2.\nThe reason is that the _ couldn’t been recognized by the open3 command, so open3 launch the command “perl server.pl daemon -l http://_:0” as a string via a bash subprocess, which run sh -c “perl server.pl daemon -l http://*:0”. Thus, we know the reason behind it was we just kill the bash subprocess, not the server process.\nThe fix is easy: replace it with “localhost” or “127.0.0.1”.\nproblem on windows Until this step, everything works fun on linux, however, on windows, the program stucked.\nAfter investigation, I found the windows prefer the syntax:\n1 open3(my *IN, my *OUT, my *ERR, $cmd); It was solved very easily. But I spent a lot of time on it.\nConclusion Even if this is just a not so hard unit test, I spent a lot of time to deal with the async problem, IPC problem, the stand output and error log problem. These things are very tricky to deal with.\n",
  "wordCount" : "644",
  "inLanguage": "en",
  "datePublished": "2023-11-21T21:05:14-04:00",
  "dateModified": "2023-11-21T21:05:14-04:00",
  "author":{
    "@type": "Person",
    "name": "Xi Chen"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://xichen1997.github.io/posts/2023-11-21-the-lessons-i-learned-from-setting-up-an-api-server-via-perl-script/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Xi's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://xichen1997.github.io/favicon.ico"
    }
  }
}
</script>
</head>
<body id="top">
    <header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://xichen1997.github.io/" accesskey="h" title="Xi&#39;s Blog (Alt + H)">Xi&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://xichen1997.github.io/posts/" title="Posts">
                    <span>Posts</span>
                </a>
            </li>
            <li>
                <a href="https://xichen1997.github.io/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://xichen1997.github.io/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://xichen1997.github.io/">Home</a>&nbsp;»&nbsp;<a href="https://xichen1997.github.io/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      The lessons I learned from setting up an API server via perl script
    </h1>
    <div class="post-meta"><span title='2023-11-21 21:05:14 -0400 -0400'>November 21, 2023</span>&nbsp;·&nbsp;<span>4 min</span>&nbsp;·&nbsp;<span>644 words</span>&nbsp;·&nbsp;<span>Xi Chen</span>

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><nav id="TableOfContents">
  <ul>
    <li><a href="#problem-statement">Problem Statement</a></li>
    <li><a href="#error-examples">Error examples</a>
      <ul>
        <li><a href="#the-residual-server-processes-cant-be-killed">The residual server processes can&rsquo;t be killed.</a></li>
        <li><a href="#program-stucked-after-launch-the-api-server">Program stucked after launch the API server.</a></li>
        <li><a href="#problem-on-windows">problem on windows</a></li>
      </ul>
    </li>
    <li><a href="#conclusion">Conclusion</a></li>
  </ul>
</nav>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="problem-statement">Problem Statement<a hidden class="anchor" aria-hidden="true" href="#problem-statement">#</a></h2>
<p>Recently When I was trying to set up an API server in a perl script to do some unit tests, I met lots of trouble.</p>
<p>In conclusion, the trouble can be classfied as 3 parts:</p>
<ol>
<li>The residual server processes can&rsquo;t be killed properly.</li>
<li>Program stucked after launch the API server.</li>
<li>stdin, stdout, stderr on windows.</li>
</ol>
<h2 id="error-examples">Error examples<a hidden class="anchor" aria-hidden="true" href="#error-examples">#</a></h2>
<h3 id="the-residual-server-processes-cant-be-killed">The residual server processes can&rsquo;t be killed.<a hidden class="anchor" aria-hidden="true" href="#the-residual-server-processes-cant-be-killed">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-perl" data-lang="perl"><span class="line"><span class="cl"><span class="nb">system</span><span class="p">(</span><span class="n">perl</span> <span class="n">server</span><span class="o">.</span><span class="n">pl</span> <span class="n">daemon</span> <span class="o">-</span><span class="n">l</span> <span class="n">http:</span><span class="sr">//</span><span class="o">*</span><span class="p">:</span><span class="mi">0</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Use the command above in main test script will launch an API server in a child process. The residual server processes should be killed without any left after the tests. At first I use &ldquo;system&rdquo; to run the command, and then kill it in a different system command via:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ps aux <span class="se">\|</span> grep <span class="s2">&#34;xxx&#34;</span> <span class="se">\|</span> awk <span class="o">{</span>print <span class="nv">$2</span><span class="o">}</span><span class="s2">&#34; \| xargs kill
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>However, my tests need to be run on all platform including windows, then it&rsquo;s not possible to use the UNIX/MAC specific command to kill the processes.</p>
<p>Of course I can use</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-perl" data-lang="perl"><span class="line"><span class="cl"><span class="k">print</span> <span class="s">&#34;$^0&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>to detect different OS and use different command to kill them, but I don&rsquo;t because I am afraid of some problem which unspecified platform will show up. I would like to use the naive perl method.</p>
<p>Then the question become how to get the pid from the &ldquo;system&rdquo; command in perl, here, I use open3 [https://perldoc.perl.org/IPC::Open3]</p>
<p>The open3 will return a pid number, which could be used by perl to execute:</p>
<p>Kill &lsquo;TERM&rsquo;, $pid. which is quiet convenient.</p>
<p>The command is:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-perl" data-lang="perl"><span class="line"><span class="cl"><span class="k">my</span> <span class="nv">$pid</span> <span class="o">=</span> <span class="n">open3</span><span class="p">(</span><span class="k">my</span> <span class="nv">$in</span><span class="p">,</span> <span class="k">my</span> <span class="nv">$out</span><span class="p">,</span> <span class="k">my</span> <span class="nv">$err</span><span class="p">,</span> <span class="s">&#34;perl server.pl daemon -l http://*:0&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nb">kill</span> <span class="s">&#39;TERM&#39;</span><span class="p">,</span> <span class="nv">$pid</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>It should be fine to solve the problem, however, then I met the second question: The test is stucked once the child processes launch the API server.</p>
<h3 id="program-stucked-after-launch-the-api-server">Program stucked after launch the API server.<a hidden class="anchor" aria-hidden="true" href="#program-stucked-after-launch-the-api-server">#</a></h3>
<p>This is quiet interesting caused by open3.</p>
<p>open3 will open the subprocess with its stdin, stdout and stderr. However, there is buffer setting in linux terminal(not sure if there is in windows os.). So the buffer always waiting for some output to accumulate and then release them. The api server always waiting for new output, however, it never reached the requirements of the buffer. Then the program stucked.</p>
<p>Two ways to solve the problem:</p>
<ol>
<li>
<p>use &ldquo;unbuffer&rdquo; to launch the server:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-perl" data-lang="perl"><span class="line"><span class="cl"><span class="k">my</span> <span class="nv">$pid</span> <span class="o">=</span> <span class="n">open3</span><span class="p">(</span><span class="k">my</span> <span class="nv">$in</span><span class="p">,</span> <span class="k">my</span> <span class="nv">$out</span><span class="p">,</span> <span class="k">my</span> <span class="nv">$err</span><span class="p">,</span> <span class="s">&#34;unbuffer perl server.pl daemon -l http://*:0&#34;</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>However, this can&rsquo;t be done on windows.</p>
</li>
<li>
<p>In the server.pl, add <code>|=1</code> to force flush buffer.</p>
</li>
</ol>
<p>It should solve the problem of stucked program.</p>
<p>However, new problem showed up:</p>
<p>The server.pl still alive after successfully tests.</p>
<p>I can still use <code>ps aux | grep &quot;server.pl&quot;</code> to find 4-5 processes.</p>
<p>After careful thinking, I made an experiment which I will comment the &ldquo;kill&rdquo; in each tests, and after running the tests I found the residual processes have twice than before. This means the open3 launch not only 1 subprocess but 2.</p>
<p>The reason is that the _ couldn&rsquo;t been recognized by the open3 command, so open3 launch the command &ldquo;perl server.pl daemon -l http://_:0&rdquo; as a string via a bash subprocess, which run sh -c &ldquo;perl server.pl daemon -l http://*:0&rdquo;. Thus, we know the reason behind it was we just kill the bash subprocess, not the server process.</p>
<p>The fix is easy: replace it with &ldquo;localhost&rdquo; or &ldquo;127.0.0.1&rdquo;.</p>
<h3 id="problem-on-windows">problem on windows<a hidden class="anchor" aria-hidden="true" href="#problem-on-windows">#</a></h3>
<p>Until this step, everything works fun on linux, however, on windows, the program stucked.</p>
<p>After investigation, I found the windows prefer the syntax:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-perl" data-lang="perl"><span class="line"><span class="cl"><span class="n">open3</span><span class="p">(</span><span class="k">my</span> <span class="o">*</span><span class="n">IN</span><span class="p">,</span> <span class="k">my</span> <span class="o">*</span><span class="n">OUT</span><span class="p">,</span> <span class="k">my</span> <span class="o">*</span><span class="n">ERR</span><span class="p">,</span> <span class="nv">$cmd</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>It was solved very easily. But I spent a lot of time on it.</p>
<h2 id="conclusion">Conclusion<a hidden class="anchor" aria-hidden="true" href="#conclusion">#</a></h2>
<p>Even if this is just a not so hard unit test, I spent a lot of time to deal with the async problem, IPC problem, the stand output and error log problem. These things are very tricky to deal with.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://xichen1997.github.io/tags/perl/">Perl</a></li>
      <li><a href="https://xichen1997.github.io/tags/api/">API</a></li>
      <li><a href="https://xichen1997.github.io/tags/ipc/">IPC</a></li>
      <li><a href="https://xichen1997.github.io/tags/debugging/">Debugging</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://xichen1997.github.io/posts/2024-02-24-several-issues-i-meet-when-plug-in-new-rtx-4090-gpu-for-my-workstation/">
    <span class="title">« Prev</span>
    <br>
    <span>Several issues I meet when plug in new RTX 4090 GPU for my workstation</span>
  </a>
  <a class="next" href="https://xichen1997.github.io/posts/2023-10-01-why-i-open-this-blog/">
    <span class="title">Next »</span>
    <br>
    <span>Why I open this blog</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2026 <a href="https://xichen1997.github.io/">Xi&#39;s Blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu');
    if (menu) {
        
        const scrollPosition = localStorage.getItem("menu-scroll-position");
        if (scrollPosition) {
            menu.scrollLeft = parseInt(scrollPosition, 10);
        }
        
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        const html = document.querySelector("html");
        if (html.dataset.theme === "dark") {
            html.dataset.theme = 'light';
            localStorage.setItem("pref-theme", 'light');
        } else {
            html.dataset.theme = 'dark';
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
